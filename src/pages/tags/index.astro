---
import Breadcrumb from "@/components/Breadcrumb.astro";
import Header from "@/components/Header.astro";
import Link from "@/components/Link.astro";
import { SITE } from "@/consts";
import Layout from "@/layouts/Layout.astro";
import { getAllBlogTagsWithCount, getAllProjectTagsWithCount } from "@/lib/data-utils";
import { Tag as TagIcon } from "lucide-astro";

// Get tags from both blogs and projects
const blogTags = await getAllBlogTagsWithCount();
const projectTags = await getAllProjectTagsWithCount();

// Combine tags and their counts
const tagMap = new Map<string, { blogCount: number; projectCount: number }>();

blogTags.forEach(({ tag, count }) => {
  tagMap.set(tag, { blogCount: count, projectCount: 0 });
});

projectTags.forEach(({ tag, count }) => {
  const existing = tagMap.get(tag);
  if (existing) {
    existing.projectCount = count;
  } else {
    tagMap.set(tag, { blogCount: 0, projectCount: count });
  }
});

// Convert to array and sort alphabetically
const tags = Array.from(tagMap.entries())
  .map(([tag, counts]) => ({
    tag,
    blogCount: counts.blogCount,
    projectCount: counts.projectCount,
    totalCount: counts.blogCount + counts.projectCount,
  }))
  .sort((a, b) => a.tag.localeCompare(b.tag));
---

<Layout
  title={`All Tags - ${SITE.title}`}
  description="Browse all blog posts and projects by topic. Explore tags and discover content that interests you."
  jsonLd={{ type: "website" }}
>
  <Header slot="header" />
  <main class="w-full mx-auto flex grow flex-col gap-y-8 px-4 max-w-3xl pb-12">
    <!-- Breadcrumb -->
    <Breadcrumb
      items={[
        { label: "Home", href: "/", icon: "home" },
        { label: "Tags", icon: "tags" },
      ]}
    />

    <!-- Header - Searchable -->
    <div class="flex flex-col gap-y-3" data-pagefind-body>
      <div class="flex items-center gap-3">
        <div class="p-2 bg-muted rounded-md">
          <TagIcon size={20} class="text-muted-foreground" />
        </div>
        <div>
          <h1 class="text-3xl font-bold text-foreground">All Tags</h1>
          <p class="text-sm text-muted-foreground">Browse posts and projects by topic</p>
        </div>
      </div>
    </div>

    <!-- Tags -->
    {
      tags.length > 0 ? (
        <div class="flex flex-wrap gap-2">
          {tags.map(({ tag, totalCount }) => (
            <Link
              href={`/tags/${tag}`}
              class="inline-flex items-center gap-2 px-3 py-2 bg-muted hover:bg-muted/80 text-foreground rounded-md transition-colors group"
            >
              <span class="text-sm group-hover:text-primary transition-colors">{tag}</span>
              <span class="text-xs text-muted-foreground">({totalCount})</span>
            </Link>
          ))}
        </div>
      ) : (
        <p class="text-muted-foreground text-center py-8">No tags found.</p>
      )
    }
  </main>
</Layout>
