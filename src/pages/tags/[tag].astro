---
import BlogCard from "@/components/BlogCard.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import Link from "@/components/Link.astro";
import ProjectCard from "@/components/ProjectCard.astro";
import { SITE } from "@/consts";
import Layout from "@/layouts/Layout.astro";
import { getAllBlogPosts, getAllBlogTags } from "@/lib/blog";
import { groupByYear } from "@/lib/group-by-year";
import { getAllProjects, getAllProjectTags, sortProjects } from "@/lib/projects";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const blogTags = await getAllBlogTags();
  const projectTags = await getAllProjectTags();

  // Get all unique tags
  const allTags = Array.from(new Set([...blogTags, ...projectTags])).sort();

  const allPosts = await getAllBlogPosts();
  const allProjects = await getAllProjects();

  return allTags.map((tag) => {
    const filteredPosts = allPosts.filter((post) => post.data.tags.includes(tag));
    const filteredProjects = allProjects.filter((project) => project.data.tags.includes(tag));

    // Sort projects by date
    const sortedProjects = sortProjects(filteredProjects, "date");

    return {
      params: { tag },
      props: { tag, posts: filteredPosts, projects: sortedProjects },
    };
  });
}

interface Props {
  tag: string;
  posts: CollectionEntry<"blog">[];
  projects: CollectionEntry<"projects">[];
}

const { tag, posts, projects } = Astro.props;
const postCount = posts.length;
const projectCount = projects.length;
const totalCount = postCount + projectCount;

// Combine and sort by date (most recent first)
type ContentItem =
  | {
      type: "blog";
      date: Date;
      item: CollectionEntry<"blog">;
    }
  | {
      type: "project";
      date: Date;
      item: CollectionEntry<"projects">;
    };

const allContent: ContentItem[] = [
  ...posts.map(
    (post): ContentItem => ({
      type: "blog",
      date: post.data.publishDate,
      item: post,
    })
  ),
  ...projects.map(
    (project): ContentItem => ({
      type: "project",
      date: project.data.startDate,
      item: project,
    })
  ),
].sort((a, b) => b.date.valueOf() - a.date.valueOf());

const contentByYear = groupByYear(allContent, (item) => item.date);
---

<Layout
  title={`Tag: ${tag} - ${SITE.title}`}
  description={`Content tagged with "${tag}" - ${postCount} ${postCount === 1 ? "post" : "posts"} and ${projectCount} ${projectCount === 1 ? "project" : "projects"}`}
  jsonLd={{ type: "website" }}
>
  <div class="w-full mx-auto flex grow flex-col gap-y-8 px-4 max-w-3xl pb-12 page-enter">
    <div class="page-enter page-enter-delay-1">
      <Breadcrumb
        items={[
          { label: "Home", href: "/", icon: "home" },
          { label: "Tags", href: "/tags", icon: "tags" },
          { label: tag, icon: "tag" },
        ]}
      />
    </div>

    <div class="flex flex-col gap-y-2 page-enter page-enter-delay-2">
      <h1 class="text-3xl font-semibold text-foreground">{tag}</h1>
      <p class="text-sm text-muted-foreground">
        {totalCount}
        {totalCount === 1 ? "item" : "items"}
        {
          postCount > 0 && projectCount > 0 && (
            <span>
              {" "}
              &middot; {postCount} {postCount === 1 ? "post" : "posts"}, {projectCount}{" "}
              {projectCount === 1 ? "project" : "projects"}
            </span>
          )
        }
      </p>
    </div>

    {
      allContent.length > 0 ? (
        <div class="flex flex-col gap-8">
          {contentByYear.map(({ year, items: yearContent }) => (
            <div class="flex flex-col gap-6">
              <div class="flex items-center gap-4 text-sm text-muted-foreground">
                <span class="tabular-nums font-medium">{year}</span>
                <div class="flex-1 border-t border-border/50" />
              </div>
              {yearContent.map(({ type, item }) =>
                type === "blog" ? <BlogCard post={item} /> : <ProjectCard project={item} />
              )}
            </div>
          ))}
        </div>
      ) : (
        <p class="text-muted-foreground text-center py-8">No content found with this tag.</p>
      )
    }

    <Link
      href="/tags"
      class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors pt-6 border-t border-border/50"
    >
      &larr; View all tags
    </Link>
  </div>
</Layout>
