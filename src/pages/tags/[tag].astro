---
import BlogCard from "@/components/BlogCard.astro";
import Header from "@/components/Header.astro";
import Link from "@/components/Link.astro";
import { SITE } from "@/consts";
import Layout from "@/layouts/Layout.astro";
import { getAllBlogPosts, getAllBlogTags } from "@/lib/data-utils";
import type { CollectionEntry } from "astro:content";
import { ChevronRight, Home, Tag as TagIcon } from "lucide-astro";

export async function getStaticPaths() {
  const allTags = await getAllBlogTags();
  const allPosts = await getAllBlogPosts();

  return allTags.map((tag) => {
    const filteredPosts = allPosts.filter((post) => post.data.tags.includes(tag));

    return {
      params: { tag },
      props: { tag, posts: filteredPosts },
    };
  });
}

interface Props {
  tag: string;
  posts: CollectionEntry<"blog">[];
}

const { tag, posts } = Astro.props;
const postCount = posts.length;
---

<Layout
  title={`Tag: ${tag} - Blog - ${SITE.title}`}
  description={`Blog posts tagged with "${tag}"`}
>
  <Header slot="header" />
  <main class="w-full mx-auto flex grow flex-col gap-y-8 px-4 max-w-3xl pb-12">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm text-muted-foreground">
      <Link href="/" class="flex items-center gap-1.5 hover:text-foreground transition-colors">
        <Home size={14} />
        <span>Home</span>
      </Link>
      <ChevronRight size={14} />
      <Link href="/tags" class="flex items-center gap-1.5 hover:text-foreground transition-colors">
        <TagIcon size={14} />
        <span>Tags</span>
      </Link>
      <ChevronRight size={14} />
      <span class="flex items-center gap-1.5 text-foreground">
        <TagIcon size={14} />
        <span>{tag}</span>
      </span>
    </nav>

    <div class="flex flex-col gap-y-3">
      <div class="flex items-center gap-3">
        <div class="p-2 bg-muted rounded-md">
          <TagIcon size={20} class="text-muted-foreground" />
        </div>
        <div>
          <h1 class="text-3xl font-bold text-foreground">{tag}</h1>
          <p class="text-sm text-muted-foreground">
            {postCount}
            {postCount === 1 ? "post" : "posts"}
          </p>
        </div>
      </div>
    </div>

    {
      posts.length > 0 ? (
        <div class="flex flex-col gap-6">
          {posts.map((post) => (
            <BlogCard post={post} />
          ))}
        </div>
      ) : (
        <p class="text-muted-foreground text-center py-8">No posts found with this tag.</p>
      )
    }

    <!-- Navigation Links -->
    <div class="flex items-center gap-4 pt-6 border-t border-border">
      <Link
        href="/tags"
        class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors"
      >
        <TagIcon size={16} />
        View all tags
      </Link>
      <span class="text-muted-foreground">â€¢</span>
      <Link
        href="/blog"
        class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors"
      >
        <svg
          width="16"
          height="16"
          viewBox="0 0 16 16"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M10 12L6 8L10 4"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
        Back to Blog
      </Link>
    </div>
  </main>
</Layout>
