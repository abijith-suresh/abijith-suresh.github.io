---
import BackLink from "@/components/BackLink.astro";
import BlogCard from "@/components/BlogCard.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import Header from "@/components/Header.astro";
import Link from "@/components/Link.astro";
import ProjectCard from "@/components/ProjectCard.astro";
import { SITE } from "@/consts";
import Layout from "@/layouts/Layout.astro";
import {
  getAllBlogPosts,
  getAllBlogTags,
  getAllProjects,
  getAllProjectTags,
  sortProjects,
} from "@/lib/data-utils";
import type { CollectionEntry } from "astro:content";
import { Tag as TagIcon } from "lucide-astro";

export async function getStaticPaths() {
  const blogTags = await getAllBlogTags();
  const projectTags = await getAllProjectTags();

  // Get all unique tags
  const allTags = Array.from(new Set([...blogTags, ...projectTags])).sort();

  const allPosts = await getAllBlogPosts();
  const allProjects = await getAllProjects();

  return allTags.map((tag) => {
    const filteredPosts = allPosts.filter((post) => post.data.tags.includes(tag));
    const filteredProjects = allProjects.filter((project) => project.data.tags.includes(tag));

    // Sort projects by date
    const sortedProjects = sortProjects(filteredProjects, "date");

    return {
      params: { tag },
      props: { tag, posts: filteredPosts, projects: sortedProjects },
    };
  });
}

interface Props {
  tag: string;
  posts: CollectionEntry<"blog">[];
  projects: CollectionEntry<"projects">[];
}

const { tag, posts, projects } = Astro.props;
const postCount = posts.length;
const projectCount = projects.length;
const totalCount = postCount + projectCount;

// Combine and sort by date (most recent first)
type ContentItem = {
  type: "blog" | "project";
  date: Date;
  item: CollectionEntry<"blog"> | CollectionEntry<"projects">;
};
const allContent: ContentItem[] = [
  ...posts.map((post) => ({
    type: "blog" as const,
    date: post.data.publishDate,
    item: post,
  })),
  ...projects.map((project) => ({
    type: "project" as const,
    date: project.data.startDate,
    item: project,
  })),
].sort((a, b) => b.date.valueOf() - a.date.valueOf());
---

<Layout
  title={`Tag: ${tag} - ${SITE.title}`}
  description={`Content tagged with "${tag}" - ${postCount} ${postCount === 1 ? "post" : "posts"} and ${projectCount} ${projectCount === 1 ? "project" : "projects"}`}
  jsonLd={{ type: "website" }}
>
  <Header slot="header" />
  <main class="w-full mx-auto flex grow flex-col gap-y-8 px-4 max-w-3xl pb-12">
    <!-- Breadcrumb -->
    <Breadcrumb
      items={[
        { label: "Home", href: "/", icon: "home" },
        { label: "Tags", href: "/tags", icon: "tags" },
        { label: tag, icon: "tag" },
      ]}
    />

    <div class="flex flex-col gap-y-3">
      <div class="flex items-center gap-3">
        <div class="p-2 bg-muted rounded-md">
          <TagIcon size={20} class="text-muted-foreground" />
        </div>
        <div>
          <h1 class="text-3xl font-bold text-foreground">{tag}</h1>
          <p class="text-sm text-muted-foreground">
            {totalCount}
            {totalCount === 1 ? "item" : "items"}
            {
              postCount > 0 && projectCount > 0 && (
                <span>
                  {" "}
                  • {postCount} {postCount === 1 ? "post" : "posts"}, {projectCount}{" "}
                  {projectCount === 1 ? "project" : "projects"}
                </span>
              )
            }
          </p>
        </div>
      </div>
    </div>

    {
      allContent.length > 0 ? (
        <div class="flex flex-col gap-6">
          {allContent.map(({ type, item }) =>
            type === "blog" ? <BlogCard post={item} /> : <ProjectCard project={item} />
          )}
        </div>
      ) : (
        <p class="text-muted-foreground text-center py-8">No content found with this tag.</p>
      )
    }

    <!-- Navigation Links -->
    <div class="flex items-center gap-4 pt-6 border-t border-border">
      <Link
        href="/tags"
        class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors"
      >
        <TagIcon size={16} />
        View all tags
      </Link>
      <span class="text-muted-foreground">•</span>
      <BackLink href="/" label="Back to Home" />
    </div>
  </main>
</Layout>
