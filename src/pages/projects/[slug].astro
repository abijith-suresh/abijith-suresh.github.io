---
import BackLink from "@/components/BackLink.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import Header from "@/components/Header.astro";
import Link from "@/components/Link.astro";
import { SITE } from "@/consts";
import Layout from "@/layouts/Layout.astro";
import { formatProjectDate } from "@/lib/data-utils";
import { cn } from "@/lib/utils";
import { type CollectionEntry, getCollection } from "astro:content";
import { Calendar } from "lucide-astro";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

interface Props {
  project: CollectionEntry<"projects">;
}

const { project } = Astro.props;
const { title, description, tags, startDate, endDate } = project.data;
const { Content } = await project.render();
const formattedDate = formatProjectDate(startDate, endDate);

// Prepare tags for Pagefind metadata (limit to first 5 for search display)
const searchTags = tags.slice(0, 5).join(", ");
---

<Layout
  title={`${title} - Projects - ${SITE.title}`}
  description={description}
  jsonLd={{ type: "article" }}
>
  <Header slot="header" />
  <main class="w-full mx-auto flex grow flex-col gap-y-6 px-4 max-w-3xl pb-12">
    <!-- Breadcrumb -->
    <Breadcrumb
      items={[
        { label: "Home", href: "/", icon: "home" },
        { label: "Projects", href: "/projects", icon: "projects" },
        { label: title, icon: "project" },
      ]}
    />

    <!-- Project Header -->
    <article
      class="flex flex-col gap-y-6"
      data-pagefind-body
      data-pagefind-meta={`tags:${searchTags},content_type:project`}
    >
      <header class="flex flex-col gap-y-4 text-center">
        <h1 class="text-3xl sm:text-4xl font-bold text-foreground">{title}</h1>

        <div
          class="flex flex-wrap items-center justify-center gap-x-2 gap-y-1 text-sm text-muted-foreground"
        >
          <div class="flex items-center gap-1.5">
            <Calendar size={16} />
            <time datetime={startDate.toISOString()}>{formattedDate}</time>
          </div>
        </div>

        <p class="text-lg text-muted-foreground max-w-2xl mx-auto">{description}</p>

        <!-- Tags -->
        <div class="flex flex-wrap justify-center gap-2">
          {
            tags.map((tag) => (
              <Link
                href={`/tags/${tag}`}
                class:list={cn(
                  "text-xs px-3 py-1.5 bg-muted text-muted-foreground rounded-md font-medium",
                  "hover:bg-muted/80 transition-colors"
                )}
              >
                {tag}
              </Link>
            ))
          }
        </div>
      </header>

      <!-- Project Content -->
      <div class="prose prose-neutral dark:prose-invert max-w-none">
        <Content />
      </div>
    </article>

    <!-- Back to Projects -->
    <BackLink href="/projects" label="Back to Projects" />
  </main>
</Layout>
