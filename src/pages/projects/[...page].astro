---
import Breadcrumb from "@/components/Breadcrumb.astro";
import PaginatedListLayout from "@/components/PaginatedListLayout.astro";
import ProjectCard from "@/components/ProjectCard.astro";
import { SITE } from "@/consts";
import Layout from "@/layouts/Layout.astro";
import { groupByYear } from "@/lib/group-by-year";
import { paginate } from "@/lib/pagination";
import { getAllProjects, sortProjects } from "@/lib/projects";
import type { CollectionEntry } from "astro:content";
export async function getStaticPaths() {
  const allProjects = await getAllProjects();
  const sortedProjects = sortProjects(allProjects, "date");
  const totalProjects = sortedProjects.length;
  const totalPages = Math.ceil(totalProjects / SITE.projectsPerPage);

  // Generate paths for all pages
  return Array.from({ length: totalPages }, (_, i) => {
    const page = i + 1;
    const paginatedProjects = paginate(sortedProjects, page, SITE.projectsPerPage);

    return {
      params: { page: page === 1 ? undefined : String(page) },
      props: { ...paginatedProjects },
    };
  });
}

interface Props {
  items: CollectionEntry<"projects">[];
  currentPage: number;
  totalPages: number;
  hasNext: boolean;
  hasPrev: boolean;
}

const { items: projects, currentPage, totalPages, hasNext, hasPrev } = Astro.props;

const prevUrl = hasPrev ? (currentPage === 2 ? "/projects" : `/projects/${currentPage - 1}`) : null;
const nextUrl = hasNext ? `/projects/${currentPage + 1}` : null;

const projectsByYear = groupByYear(projects, (project) => project.data.startDate);
---

<Layout
  title={`Projects${currentPage > 1 ? ` - Page ${currentPage}` : ""} - ${SITE.title}`}
  description="A collection of projects I've built, including web applications, tools, and experiments."
  jsonLd={{ type: "website" }}
>
  <div class="w-full mx-auto flex grow flex-col gap-y-8 px-4 max-w-3xl pb-12 page-enter">
    <div class="page-enter page-enter-delay-1">
      <Breadcrumb
        items={[
          { label: "Home", href: "/", icon: "home" },
          { label: "Projects", icon: "projects" },
        ]}
      />
    </div>

    <div class="flex flex-col gap-y-2 page-enter page-enter-delay-2">
      <h1 class="text-3xl font-semibold text-foreground">Projects</h1>
      <p class="text-muted-foreground">
        A collection of projects I've built, ranging from web applications to CLI tools.
      </p>
    </div>

    {
      projects.length > 0 ? (
        <>
          <PaginatedListLayout
            currentPage={currentPage}
            totalPages={totalPages}
            prevUrl={prevUrl}
            nextUrl={nextUrl}
            hasPrev={hasPrev}
            hasNext={hasNext}
            ariaLabel="Project pagination"
          >
            <div slot="items" class="flex flex-col gap-8">
              {projectsByYear.map(({ year, items: yearProjects }) => (
                <div class="flex flex-col gap-6">
                  <div class="flex items-center gap-4 text-sm text-muted-foreground">
                    <span class="tabular-nums font-medium">{year}</span>
                    <div class="flex-1 border-t border-border/50" />
                  </div>
                  {yearProjects.map((project) => (
                    <ProjectCard project={project} />
                  ))}
                </div>
              ))}
            </div>
          </PaginatedListLayout>
        </>
      ) : (
        <p class="text-muted-foreground text-center py-8">No projects to display yet.</p>
      )
    }
  </div>
</Layout>
