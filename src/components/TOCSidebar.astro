---
import type { MarkdownHeading } from "astro";
import { filterTocHeadings } from "@/lib/toc";

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;
const filteredHeadings = filterTocHeadings(headings);

function getIndent(depth: number): string {
  return depth === 3 ? "ml-4" : "";
}
---

{
  filteredHeadings.length > 0 && (
    <div
      id="toc-sidebar-container"
      class="sticky top-20 col-start-1 row-span-1 mr-8 ml-auto hidden h-[calc(100vh-5rem)] max-w-64 lg:block"
    >
      <div class="flex max-h-[calc(100vh-8rem)] flex-col overflow-y-auto pr-4">
        <span class="text-base font-semibold mb-3">On this page</span>
        <ul class="flex list-none flex-col gap-y-2" id="toc-sidebar-list">
          {filteredHeadings.map((heading) => (
            <li class:list={["text-sm text-foreground/60", getIndent(heading.depth)]}>
              <a
                href={`#${heading.slug}`}
                class="toc-sidebar-link underline decoration-transparent underline-offset-[3px] transition-all duration-200 hover:decoration-inherit hover:text-foreground"
                data-heading-link={heading.slug}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </div>
  )
}

<script>
  import { createDesktopTocController } from "@/lib/toc";

  const controller = createDesktopTocController({
    headingSelector: ".prose h2[id], .prose h3[id]",
    headerOffset: 100,
    containerSelector: "#toc-sidebar-container",
    linkSelector: "[data-heading-link]",
    activeClass: "text-foreground",
    enableSmoothScroll: true,
  });

  document.addEventListener("astro:page-load", () => controller.init());
  document.addEventListener("astro:after-swap", () => {
    controller.cleanup();
    controller.init();
  });
  document.addEventListener("astro:before-swap", () => controller.cleanup());
</script>
