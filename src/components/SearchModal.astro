---
import { X } from "lucide-astro";
---

<!-- Modal Overlay -->
<div
  id="search-modal"
  class="fixed inset-0 z-50 hidden bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0"
  aria-hidden="true"
  data-state="closed"
>
  <!-- Modal Container -->
  <div
    class="fixed left-1/2 top-0 sm:top-[10%] z-50 w-full max-w-full sm:max-w-lg md:max-w-2xl -translate-x-1/2 translate-y-0"
  >
    <div
      class="relative flex flex-col h-[100dvh] sm:h-auto sm:max-h-[85vh] bg-background shadow-lg border border-border rounded-none sm:rounded-lg overflow-hidden data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:slide-out-to-top-0 data-[state=open]:slide-in-from-top-0 duration-200"
      role="dialog"
      aria-modal="true"
      aria-labelledby="search-title"
      data-state="closed"
    >
      <!-- Close Button (Desktop) - Absolute positioned -->
      <button
        id="close-search-modal-desktop"
        aria-label="Close search"
        class="hidden sm:block absolute right-4 top-4 p-1.5 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md transition-colors z-10"
      >
        <X size={16} />
      </button>

      <!-- Search Content -->
      <div class="flex-1 min-h-0 overflow-hidden">
        <div id="search-container"></div>
      </div>
    </div>
  </div>
</div>

<style is:global>
  :root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: var(--primary);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-tag: var(--muted);
    --pagefind-ui-border-width: 0px;
    --pagefind-ui-border-radius: 0;
    --pagefind-ui-image-border-radius: 0.5rem;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-font: inherit;
  }

  /* Hide default Pagefind wrapper elements */
  .pagefind-ui {
    border: none !important;
    border-radius: 0 !important;
    background: transparent !important;
    padding: 0 !important;
  }

  /* Search input styling */
  .pagefind-ui__form {
    border-bottom: 1px solid var(--border) !important;
    padding: 0 !important;
    margin: 0 !important;
    background: transparent !important;
  }

  .pagefind-ui__search-input {
    background-color: transparent !important;
    border: none !important;
    color: var(--foreground) !important;
    font-size: 1rem !important;
    padding: 1rem 1rem 1rem 3rem !important;
    height: 3.5rem !important;
    outline: none !important;
    box-shadow: none !important;
  }

  .pagefind-ui__search-input:focus {
    outline: none !important;
    box-shadow: none !important;
    border: none !important;
  }

  .pagefind-ui__search-input::placeholder {
    color: var(--muted-foreground) !important;
  }

  /* Search icon */
  .pagefind-ui__search-clear {
    display: none !important;
  }

  /* Results container */
  .pagefind-ui__results {
    padding: 0 !important;
    margin: 0 !important;
    max-height: calc(85vh - 4rem) !important;
    overflow-y: auto !important;
    overscroll-behavior: contain !important;
    -webkit-overflow-scrolling: touch !important;
  }

  @media (max-width: 640px) {
    .pagefind-ui__results {
      max-height: calc(100dvh - 4rem) !important;
    }
  }

  /* Individual result item */
  .pagefind-ui__result {
    border: none !important;
    border-bottom: 1px solid var(--border) !important;
    background-color: transparent !important;
    padding: 1rem !important;
    margin: 0 !important;
    border-radius: 0 !important;
  }

  .pagefind-ui__result:hover {
    background-color: var(--muted) !important;
  }

  .pagefind-ui__result:last-child {
    border-bottom: none !important;
  }

  .pagefind-ui__result-link {
    text-decoration: none !important;
  }

  /* Result title */
  .pagefind-ui__result-title {
    color: var(--foreground) !important;
    font-size: 0.95rem !important;
    font-weight: 500 !important;
    margin-bottom: 0.25rem !important;
  }

  /* Result excerpt */
  .pagefind-ui__result-excerpt {
    color: var(--muted-foreground) !important;
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
    margin: 0.25rem 0 !important;
  }

  /* Result tags */
  .pagefind-ui__result-tags {
    margin-top: 0.5rem !important;
  }

  .pagefind-ui__result-tag {
    background-color: var(--muted) !important;
    color: var(--muted-foreground) !important;
    border: none !important;
    font-size: 0.75rem !important;
    padding: 0.125rem 0.5rem !important;
    border-radius: 0.25rem !important;
  }

  /* Message styling (no results, loading, etc.) */
  .pagefind-ui__message {
    color: var(--muted-foreground) !important;
    padding: 2rem 1rem !important;
    text-align: center !important;
    font-size: 0.875rem !important;
  }

  /* Load more button */
  .pagefind-ui__button {
    background-color: var(--primary) !important;
    color: var(--primary-foreground) !important;
    border: none !important;
    padding: 0.5rem 1rem !important;
    border-radius: 0.375rem !important;
    font-size: 0.875rem !important;
    margin: 1rem auto !important;
    display: block !important;
  }

  .pagefind-ui__button:hover {
    opacity: 0.9 !important;
  }

  /* Hide result image/thumbnail */
  .pagefind-ui__result-image {
    display: none !important;
  }

  /* Prevent body scroll when modal is open */
  body.search-modal-open {
    overflow: hidden;
  }

  /* Animation keyframes */
  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fade-out {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  @keyframes slide-in-from-top {
    from {
      transform: translateY(-100%);
    }
    to {
      transform: translateY(0);
    }
  }

  @keyframes slide-out-to-top {
    from {
      transform: translateY(0);
    }
    to {
      transform: translateY(-100%);
    }
  }

  [data-state="open"] {
    animation: fade-in var(--transition-normal) var(--ease-default);
  }

  [data-state="closed"] {
    animation: fade-out var(--transition-normal) var(--ease-default);
  }
</style>

<script>
  import { PagefindUI } from "@pagefind/default-ui";

  let pagefindInstance: PagefindUI | null = null;

  function openSearchModal() {
    const modal = document.getElementById("search-modal");
    const modalContent = modal?.querySelector('[role="dialog"]');
    if (!modal || !modalContent) return;

    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
    modal.setAttribute("data-state", "open");
    modalContent.setAttribute("data-state", "open");
    document.body.classList.add("search-modal-open");

    // Initialize Pagefind UI if not already initialized
    if (!pagefindInstance) {
      pagefindInstance = new PagefindUI({
        element: "#search-container",
        showImages: false,
        highlightParam: "highlight",
        excerptLength: 30,
      });
    }

    // Focus the search input
    setTimeout(() => {
      const searchInput = document.querySelector<HTMLInputElement>(".pagefind-ui__search-input");
      searchInput?.focus();
    }, 100);
  }

  function closeSearchModal() {
    const modal = document.getElementById("search-modal");
    const modalContent = modal?.querySelector('[role="dialog"]');
    if (!modal || !modalContent) return;

    modal.setAttribute("data-state", "closed");
    modalContent.setAttribute("data-state", "closed");

    // Wait for animation to complete before hiding
    setTimeout(() => {
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("search-modal-open");
    }, 200);
  }

  // Store event listeners for cleanup
  let openButtonClickHandler: (() => void) | null = null;
  let closeButtonDesktopClickHandler: (() => void) | null = null;
  let modalClickHandler: ((e: Event) => void) | null = null;
  let escKeyHandler: ((e: KeyboardEvent) => void) | null = null;
  let cmdKKeyHandler: ((e: KeyboardEvent) => void) | null = null;

  function initSearchModal() {
    const openButton = document.getElementById("open-search-modal");
    const closeButtonDesktop = document.getElementById("close-search-modal-desktop");
    const modal = document.getElementById("search-modal");

    // Open modal
    openButtonClickHandler = openSearchModal;
    openButton?.addEventListener("click", openButtonClickHandler);

    // Close modal buttons
    closeButtonDesktopClickHandler = closeSearchModal;
    closeButtonDesktop?.addEventListener("click", closeButtonDesktopClickHandler);

    // Close on backdrop click
    modalClickHandler = (e) => {
      if (e.target === modal) {
        closeSearchModal();
      }
    };
    modal?.addEventListener("click", modalClickHandler);

    // Close on search result click (using event delegation)
    const resultClickHandler = (e: Event) => {
      const target = e.target as HTMLElement;
      if (target.closest(".pagefind-ui__result-link")) {
        closeSearchModal();
      }
    };
    modal?.addEventListener("click", resultClickHandler);

    // Close on ESC key
    escKeyHandler = (e) => {
      if (e.key === "Escape") {
        const modal = document.getElementById("search-modal");
        if (modal && !modal.classList.contains("hidden")) {
          closeSearchModal();
        }
      }
    };
    document.addEventListener("keydown", escKeyHandler);

    // Open search modal with Cmd/Ctrl+K
    cmdKKeyHandler = (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        openSearchModal();
      }
    };
    document.addEventListener("keydown", cmdKKeyHandler);
  }

  function cleanupSearchModal() {
    const openButton = document.getElementById("open-search-modal");
    const closeButtonDesktop = document.getElementById("close-search-modal-desktop");
    const modal = document.getElementById("search-modal");

    // Remove open button handler
    if (openButtonClickHandler && openButton) {
      openButton.removeEventListener("click", openButtonClickHandler);
      openButtonClickHandler = null;
    }

    // Remove close button handler
    if (closeButtonDesktopClickHandler && closeButtonDesktop) {
      closeButtonDesktop.removeEventListener("click", closeButtonDesktopClickHandler);
      closeButtonDesktopClickHandler = null;
    }

    // Remove modal click handler
    if (modalClickHandler && modal) {
      modal.removeEventListener("click", modalClickHandler);
      modalClickHandler = null;
    }

    // Remove ESC key handler
    if (escKeyHandler) {
      document.removeEventListener("keydown", escKeyHandler);
      escKeyHandler = null;
    }

    // Remove Cmd/Ctrl+K handler
    if (cmdKKeyHandler) {
      document.removeEventListener("keydown", cmdKKeyHandler);
      cmdKKeyHandler = null;
    }
  }

  // Initialize on page load
  initSearchModal();

  // Cleanup and reinitialize on view transitions
  document.addEventListener("astro:before-swap", cleanupSearchModal);
  document.addEventListener("astro:after-swap", initSearchModal);
</script>
