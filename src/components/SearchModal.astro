---
import { X } from "lucide-astro";
---

<!-- Modal Overlay -->
<div
  id="search-modal"
  class="fixed inset-0 z-50 hidden bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0"
  aria-hidden="true"
  data-state="closed"
>
  <!-- Modal Container -->
  <div
    class="fixed left-1/2 top-0 sm:top-[10%] z-50 w-full max-w-full sm:max-w-lg md:max-w-2xl -translate-x-1/2 translate-y-0"
  >
    <div
      class="relative flex flex-col h-dvh sm:h-auto sm:max-h-[85vh] bg-background shadow-lg border border-border rounded-none sm:rounded-lg overflow-hidden data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:slide-out-to-top-0 data-[state=open]:slide-in-from-top-0 duration-200"
      role="dialog"
      aria-modal="true"
      aria-labelledby="search-title"
      data-state="closed"
    >
      <!-- Close Button (Desktop) - Absolute positioned -->
      <button
        id="close-search-modal-desktop"
        aria-label="Close search"
        class="hidden sm:block absolute right-4 top-4 p-1.5 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md transition-colors z-10"
      >
        <X size={16} />
      </button>

      <!-- Search Content -->
      <div class="flex-1 min-h-0 overflow-hidden">
        <div id="search-container"></div>
      </div>
    </div>
  </div>
</div>

<style is:global>
  :root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: var(--primary);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-tag: var(--muted);
    --pagefind-ui-border-width: 0px;
    --pagefind-ui-border-radius: 0;
    --pagefind-ui-image-border-radius: 0.5rem;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-font: inherit;
  }

  /* Hide default Pagefind wrapper elements */
  .pagefind-ui {
    border: none !important;
    border-radius: 0 !important;
    background: transparent !important;
    padding: 0 !important;
  }

  /* Search input styling */
  .pagefind-ui__form {
    border-bottom: 1px solid var(--border) !important;
    padding: 0 !important;
    margin: 0 !important;
    background: transparent !important;
  }

  .pagefind-ui__search-input {
    background-color: transparent !important;
    border: none !important;
    color: var(--foreground) !important;
    font-size: 1rem !important;
    padding: 1rem 1rem 1rem 3rem !important;
    height: 3.5rem !important;
    outline: none !important;
    box-shadow: none !important;
  }

  .pagefind-ui__search-input:focus {
    outline: none !important;
    box-shadow: none !important;
    border: none !important;
  }

  .pagefind-ui__search-input::placeholder {
    color: var(--muted-foreground) !important;
  }

  /* Search icon */
  .pagefind-ui__search-clear {
    display: none !important;
  }

  /* Results container - Scrollable */
  .pagefind-ui__results {
    padding: 0 !important;
    margin: 0 !important;
    max-height: calc(85vh - 4rem) !important;
    overflow-y: auto !important;
    overscroll-behavior: contain !important;
    -webkit-overflow-scrolling: touch !important;
  }

  @media (max-width: 640px) {
    .pagefind-ui__results {
      max-height: calc(100dvh - 4rem) !important;
    }
  }

  /* Individual result item */
  .pagefind-ui__result {
    border: none !important;
    border-bottom: 1px solid var(--border) !important;
    background-color: transparent !important;
    padding: 1rem !important;
    margin: 0 !important;
    border-radius: 0 !important;
    cursor: pointer !important;
  }

  .pagefind-ui__result:hover,
  .pagefind-ui__result[data-focused="true"] {
    background-color: var(--muted) !important;
  }

  .pagefind-ui__result:last-child {
    border-bottom: none !important;
  }

  .pagefind-ui__result-link {
    text-decoration: none !important;
  }

  /* Result title */
  .pagefind-ui__result-title {
    color: var(--foreground) !important;
    font-size: 0.95rem !important;
    font-weight: 500 !important;
    margin-bottom: 0.25rem !important;
    display: flex !important;
    align-items: center !important;
    gap: 0.5rem !important;
  }

  /* Content type icon */
  .pagefind-ui__result-title::before {
    content: "" !important;
    display: inline-block !important;
    width: 1rem !important;
    height: 1rem !important;
    flex-shrink: 0 !important;
    background-size: contain !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
    opacity: 0.7 !important;
  }

  /* Blog icon (FileText) */
  .pagefind-ui__result[data-content-type="blog"] .pagefind-ui__result-title::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z'/%3E%3Cpath d='M14 2v4a2 2 0 0 0 2 2h4'/%3E%3Cpath d='M10 9H8'/%3E%3Cpath d='M16 13H8'/%3E%3Cpath d='M16 17H8'/%3E%3C/svg%3E") !important;
  }

  /* Project icon (Code2) */
  .pagefind-ui__result[data-content-type="project"] .pagefind-ui__result-title::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m18 16 4-4-4-4'/%3E%3Cpath d='m6 8-4 4 4 4'/%3E%3Cpath d='m14.5 4-5 16'/%3E%3C/svg%3E") !important;
  }

  /* Tag icon (Tag) */
  .pagefind-ui__result[data-content-type="tag"] .pagefind-ui__result-title::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z'/%3E%3Ccircle cx='7.5' cy='7.5' r='.5' fill='%23888888'/%3E%3C/svg%3E") !important;
  }

  /* Dark mode icons - Use CSS filter to make them lighter */
  [data-theme="dark"] .pagefind-ui__result-title::before {
    filter: brightness(1.8) !important;
  }

  /* Result excerpt */
  .pagefind-ui__result-excerpt {
    color: var(--muted-foreground) !important;
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
    margin: 0.25rem 0 !important;
  }

  /* Result tags */
  .pagefind-ui__result-tags {
    margin-top: 0.5rem !important;
  }

  .pagefind-ui__result-tag {
    background-color: var(--muted) !important;
    color: var(--muted-foreground) !important;
    border: none !important;
    font-size: 0.75rem !important;
    padding: 0.125rem 0.5rem !important;
    border-radius: 0.25rem !important;
  }

  /* Message styling (no results, loading, etc.) */
  .pagefind-ui__message {
    color: var(--muted-foreground) !important;
    padding: 2rem 1rem !important;
    text-align: center !important;
    font-size: 0.875rem !important;
  }

  /* Hide results count message (e.g., "4 results for typescript") */
  .pagefind-ui__results-area > .pagefind-ui__message {
    display: none !important;
  }

  /* Load more button */
  .pagefind-ui__button {
    background-color: var(--primary) !important;
    color: var(--primary-foreground) !important;
    border: none !important;
    padding: 0.5rem 1rem !important;
    border-radius: 0.375rem !important;
    font-size: 0.875rem !important;
    margin: 1rem auto !important;
    display: block !important;
  }

  .pagefind-ui__button:hover {
    opacity: 0.9 !important;
  }

  /* Hide result image/thumbnail */
  .pagefind-ui__result-image {
    display: none !important;
  }

  /* Search term highlighting - use theme primary color */
  .pagefind-ui__result-excerpt mark,
  .pagefind-ui__result-title mark {
    background-color: hsl(var(--primary) / 0.2) !important;
    color: var(--foreground) !important;
    font-weight: 600 !important;
    border-radius: 0.125rem !important;
    padding: 0 0.125rem !important;
  }

  /* Prevent body scroll when modal is open */
  body.search-modal-open {
    overflow: hidden;
  }

  /* Animation keyframes */
  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fade-out {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  @keyframes slide-in-from-top {
    from {
      transform: translateY(-100%);
    }
    to {
      transform: translateY(0);
    }
  }

  @keyframes slide-out-to-top {
    from {
      transform: translateY(0);
    }
    to {
      transform: translateY(-100%);
    }
  }

  [data-state="open"] {
    animation: fade-in var(--transition-normal) var(--ease-default);
  }

  [data-state="closed"] {
    animation: fade-out var(--transition-normal) var(--ease-default);
  }
</style>

<script>
  import { PagefindUI } from "@pagefind/default-ui";

  let pagefindInstance: InstanceType<typeof PagefindUI> | null = null;
  let mutationObserver: MutationObserver | null = null;
  const seenTagResults = new Map<string, Element>(); // Track tag results globally
  let focusedIndex = -1; // Track currently focused result (-1 = none)
  let keyboardNavHandler: ((e: KeyboardEvent) => void) | null = null;

  // Update focused result visual state
  function updateFocusedResult() {
    const results = Array.from(document.querySelectorAll(".pagefind-ui__result"));
    results.forEach((result, index) => {
      if (index === focusedIndex) {
        result.setAttribute("data-focused", "true");
        result.scrollIntoView({ block: "nearest", behavior: "smooth" });
      } else {
        result.removeAttribute("data-focused");
      }
    });
  }

  // Handle keyboard navigation
  function handleKeyboardNavigation(e: KeyboardEvent) {
    const results = Array.from(document.querySelectorAll(".pagefind-ui__result"));
    if (results.length === 0) return;

    const searchInput = document.querySelector(".pagefind-ui__search-input");

    // Arrow keys: navigate results
    if (e.key === "ArrowDown") {
      e.preventDefault();
      focusedIndex = Math.min(focusedIndex + 1, results.length - 1);
      updateFocusedResult();
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      focusedIndex = Math.max(focusedIndex - 1, -1);
      updateFocusedResult();
      // If we're back at -1, refocus the input
      if (focusedIndex === -1 && searchInput instanceof HTMLElement) {
        searchInput.focus();
      }
    } else if (e.key === "Enter" && focusedIndex >= 0) {
      // Enter: navigate to focused result
      e.preventDefault();
      const link = results[focusedIndex].querySelector(
        ".pagefind-ui__result-link"
      ) as HTMLAnchorElement;
      if (link) {
        link.click();
      }
    }
  }

  // Attach keyboard navigation
  function attachKeyboardNavigation() {
    if (keyboardNavHandler) return; // Already attached

    keyboardNavHandler = handleKeyboardNavigation;
    document.addEventListener("keydown", keyboardNavHandler);
  }

  // Detach keyboard navigation
  function detachKeyboardNavigation() {
    if (keyboardNavHandler) {
      document.removeEventListener("keydown", keyboardNavHandler);
      keyboardNavHandler = null;
    }
  }

  // Reset focused index when search query changes
  function resetFocusedIndex() {
    focusedIndex = -1;
    updateFocusedResult();
  }

  function openSearchModal() {
    const modal = document.getElementById("search-modal");
    const modalContent = modal?.querySelector('[role="dialog"]');
    if (!modal || !modalContent) return;

    modal.classList.remove("hidden");
    modal.setAttribute("aria-hidden", "false");
    modal.setAttribute("data-state", "open");
    modalContent.setAttribute("data-state", "open");
    document.body.classList.add("search-modal-open");

    // Initialize Pagefind UI if not already initialized
    if (!pagefindInstance) {
      pagefindInstance = new PagefindUI({
        element: "#search-container",
        showImages: false,
        highlightParam: "highlight",
        excerptLength: 30,
        showSubResults: false,
        showEmptyFilters: false,
        // No pageSize limit - show all results with scrolling
      });

      // Add content type data attributes and keyboard navigation to results
      mutationObserver = new MutationObserver(() => {
        const results = document.querySelectorAll(".pagefind-ui__result");

        // Reset focused index when results change
        resetFocusedIndex();

        results.forEach((result) => {
          if (!result.hasAttribute("data-content-type")) {
            // Extract content type from the result link
            const link = result.querySelector(".pagefind-ui__result-link") as HTMLAnchorElement;
            if (link) {
              const href = link.getAttribute("href") || "";

              if (href.includes("/blog/") && !href.endsWith("/blog") && !href.endsWith("/blog/")) {
                result.setAttribute("data-content-type", "blog");
              } else if (
                href.includes("/projects/") &&
                !href.endsWith("/projects") &&
                !href.endsWith("/projects/")
              ) {
                result.setAttribute("data-content-type", "project");
              } else if (
                href.includes("/tags/") &&
                !href.endsWith("/tags") &&
                !href.endsWith("/tags/")
              ) {
                result.setAttribute("data-content-type", "tag");

                // Deduplicate tag pages (case-insensitive)
                const title = link.textContent?.trim() || "";
                const titleLower = title.toLowerCase();

                if (titleLower && seenTagResults.has(titleLower)) {
                  // Remove this duplicate completely from DOM to fix pageSize counting
                  result.remove();
                } else if (titleLower) {
                  // Track this as the first occurrence
                  seenTagResults.set(titleLower, result);
                }
              }
            }
          }
        });
      });

      // Observe the search container for changes
      const searchContainer = document.getElementById("search-container");
      if (searchContainer) {
        mutationObserver.observe(searchContainer, {
          childList: true,
          subtree: true,
        });
      }
    }

    // Attach keyboard navigation handler
    attachKeyboardNavigation();

    // Focus the search input
    setTimeout(() => {
      const searchInput = document.querySelector<HTMLInputElement>(".pagefind-ui__search-input");
      searchInput?.focus();
    }, 100);
  }

  function closeSearchModal() {
    const modal = document.getElementById("search-modal");
    const modalContent = modal?.querySelector('[role="dialog"]');
    if (!modal || !modalContent) return;

    // Detach keyboard navigation
    detachKeyboardNavigation();
    resetFocusedIndex();

    modal.setAttribute("data-state", "closed");
    modalContent.setAttribute("data-state", "closed");

    // Wait for animation to complete before hiding
    setTimeout(() => {
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden", "true");
      document.body.classList.remove("search-modal-open");
    }, 200);
  }

  // Store event listeners for cleanup
  let openButtonClickHandler: (() => void) | null = null;
  let closeButtonDesktopClickHandler: (() => void) | null = null;
  let modalClickHandler: ((e: Event) => void) | null = null;
  let escKeyHandler: ((e: KeyboardEvent) => void) | null = null;
  let cmdKKeyHandler: ((e: KeyboardEvent) => void) | null = null;

  function initSearchModal() {
    const openButton = document.getElementById("open-search-modal");
    const closeButtonDesktop = document.getElementById("close-search-modal-desktop");
    const modal = document.getElementById("search-modal");

    // Open modal
    openButtonClickHandler = openSearchModal;
    openButton?.addEventListener("click", openButtonClickHandler);

    // Close modal buttons
    closeButtonDesktopClickHandler = closeSearchModal;
    closeButtonDesktop?.addEventListener("click", closeButtonDesktopClickHandler);

    // Close on backdrop click
    modalClickHandler = (e) => {
      if (e.target === modal) {
        closeSearchModal();
      }
    };
    modal?.addEventListener("click", modalClickHandler);

    // Close on search result click (using event delegation)
    const resultClickHandler = (e: Event) => {
      const target = e.target as HTMLElement;
      if (target.closest(".pagefind-ui__result-link")) {
        closeSearchModal();
      }
    };
    modal?.addEventListener("click", resultClickHandler);

    // Close on ESC key
    escKeyHandler = (e) => {
      if (e.key === "Escape") {
        const modal = document.getElementById("search-modal");
        if (modal && !modal.classList.contains("hidden")) {
          closeSearchModal();
        }
      }
    };
    document.addEventListener("keydown", escKeyHandler);

    // Open search modal with Cmd/Ctrl+K
    cmdKKeyHandler = (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        openSearchModal();
      }
    };
    document.addEventListener("keydown", cmdKKeyHandler);
  }

  function cleanupSearchModal() {
    const openButton = document.getElementById("open-search-modal");
    const closeButtonDesktop = document.getElementById("close-search-modal-desktop");
    const modal = document.getElementById("search-modal");

    // Remove open button handler
    if (openButtonClickHandler && openButton) {
      openButton.removeEventListener("click", openButtonClickHandler);
      openButtonClickHandler = null;
    }

    // Remove close button handler
    if (closeButtonDesktopClickHandler && closeButtonDesktop) {
      closeButtonDesktop.removeEventListener("click", closeButtonDesktopClickHandler);
      closeButtonDesktopClickHandler = null;
    }

    // Remove modal click handler
    if (modalClickHandler && modal) {
      modal.removeEventListener("click", modalClickHandler);
      modalClickHandler = null;
    }

    // Remove ESC key handler
    if (escKeyHandler) {
      document.removeEventListener("keydown", escKeyHandler);
      escKeyHandler = null;
    }

    // Remove Cmd/Ctrl+K handler
    if (cmdKKeyHandler) {
      document.removeEventListener("keydown", cmdKKeyHandler);
      cmdKKeyHandler = null;
    }

    // Disconnect MutationObserver
    if (mutationObserver) {
      mutationObserver.disconnect();
      mutationObserver = null;
    }

    // Remove keyboard navigation handler
    detachKeyboardNavigation();

    // Clear tag tracking
    seenTagResults.clear();

    // Reset focused index
    focusedIndex = -1;

    // Reset pagefind instance
    pagefindInstance = null;
  }

  // Initialize on page load
  initSearchModal();

  // Cleanup and reinitialize on view transitions
  document.addEventListener("astro:before-swap", cleanupSearchModal);
  document.addEventListener("astro:after-swap", initSearchModal);
</script>
