---
import { FileText, Search, X } from "lucide-astro";
---

<!-- Search Modal -->
<div
  id="search-modal"
  class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm"
  aria-hidden="true"
  data-state="closed"
  style="view-transition-name: none;"
>
  <div
    class="fixed left-1/2 top-0 sm:top-[10%] z-50 w-full max-w-full sm:max-w-lg md:max-w-2xl -translate-x-1/2 translate-y-0"
  >
    <div
      id="search-modal-content"
      class="relative flex flex-col h-dvh sm:h-auto sm:max-h-[85vh] bg-background shadow-lg border border-border rounded-none sm:rounded-lg overflow-hidden"
      role="dialog"
      aria-modal="true"
      aria-labelledby="search-title"
      style="view-transition-name: none;"
    >
      <!-- Header with Search Input -->
      <div class="flex items-center gap-3 px-4 py-4 border-b border-border">
        <Search class="w-5 h-5 text-muted-foreground shrink-0" />
        <input
          id="search-input"
          type="text"
          placeholder="Search posts and projects..."
          class="flex-1 bg-transparent border-0 outline-none text-foreground placeholder:text-muted-foreground text-base"
          autocomplete="off"
        />
        <button
          id="close-search-modal"
          class="p-2 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md transition-colors shrink-0"
          aria-label="Close search"
        >
          <X class="w-4 h-4" />
        </button>
      </div>

      <!-- Results Container -->
      <div id="search-results" class="flex-1 min-h-0 overflow-y-auto overscroll-contain">
        <!-- Skeleton Loading State -->
        <div id="search-skeleton" class="hidden">
          {
            [1, 2, 3, 4].map((_i) => (
              <div class="p-4 border-b border-border animate-pulse">
                <div class="flex items-start gap-3">
                  <div class="w-4 h-4 bg-muted rounded mt-1 shrink-0" />
                  <div class="flex-1 space-y-2">
                    <div class="h-4 bg-muted rounded w-3/4" />
                    <div class="h-3 bg-muted rounded w-full" />
                    <div class="h-3 bg-muted rounded w-2/3" />
                  </div>
                </div>
              </div>
            ))
          }
        </div>

        <!-- No Results State -->
        <div
          id="search-empty"
          class="hidden flex-col items-center justify-center py-12 px-4 text-center"
        >
          <div class="w-16 h-16 rounded-full bg-muted flex items-center justify-center mb-4">
            <FileText class="w-8 h-8 text-muted-foreground" />
          </div>
          <h3 class="text-lg font-medium text-foreground mb-2">No results found</h3>
          <p class="text-sm text-muted-foreground max-w-sm mb-6">
            We couldn't find any matches for your search. Try different keywords or check your
            spelling.
          </p>
          <div class="flex flex-wrap gap-2 justify-center">
            <a
              href="/blog"
              class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:opacity-90 transition-opacity"
            >
              Browse Blog
            </a>
            <a
              href="/projects"
              class="px-4 py-2 bg-muted text-foreground rounded-md text-sm font-medium hover:bg-muted/80 transition-colors"
            >
              Browse Projects
            </a>
          </div>
        </div>

        <!-- Error State -->
        <div
          id="search-error"
          class="hidden flex-col items-center justify-center py-12 px-4 text-center"
        >
          <div
            class="w-16 h-16 rounded-full bg-destructive/10 flex items-center justify-center mb-4"
          >
            <svg
              class="w-8 h-8 text-destructive"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width={2}
                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
              ></path>
            </svg>
          </div>
          <h3 class="text-lg font-medium text-foreground mb-2">Something went wrong</h3>
          <p class="text-sm text-muted-foreground max-w-sm mb-4">
            Failed to load search. Please try again later.
          </p>
          <button
            id="retry-search"
            class="px-4 py-2 bg-primary text-primary-foreground rounded-md text-sm font-medium hover:opacity-90 transition-opacity"
          >
            Try Again
          </button>
        </div>

        <!-- Results List -->
        <div id="search-results-list" class="hidden">
          <div id="results-container" class="divide-y divide-border"></div>

          <!-- Load More Button -->
          <div id="load-more-container" class="hidden p-4">
            <button
              id="load-more-btn"
              class="w-full py-2 px-4 bg-muted text-foreground rounded-md text-sm font-medium hover:bg-muted/80 transition-colors"
            >
              Load more results
            </button>
          </div>
        </div>
      </div>

      <!-- Keyboard Shortcuts Footer -->
      <div
        id="search-footer"
        class="hidden shrink-0 items-center justify-center gap-4 p-3 border-t border-border bg-muted/50 text-xs text-muted-foreground flex-wrap"
      >
        <span class="flex items-center gap-1">
          <kbd class="px-1.5 py-0.5 bg-background border rounded text-[10px] font-mono">↑↓</kbd>
          <span>navigate</span>
        </span>
        <span class="flex items-center gap-1">
          <kbd class="px-1.5 py-0.5 bg-background border rounded text-[10px] font-mono">↵</kbd>
          <span>select</span>
        </span>
        <span class="flex items-center gap-1">
          <kbd class="px-1.5 py-0.5 bg-background border rounded text-[10px] font-mono">esc</kbd>
          <span>close</span>
        </span>
      </div>
    </div>
  </div>
</div>

<style is:global>
  /* Search modal animations */
  #search-modal[data-state="open"] {
    animation: fadeIn 150ms ease-out;
  }

  #search-modal[data-state="closed"] {
    animation: fadeOut 150ms ease-in forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fadeOut {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  /* Prevent body scroll when modal is open */
  body.search-modal-open {
    overflow: hidden;
  }

  /* Search result item focus state */
  .search-result-item {
    transition: background-color 150ms ease;
  }

  .search-result-item:hover,
  .search-result-item[data-focused="true"] {
    background-color: var(--muted);
  }

  /* Highlight search terms */
  .search-highlight {
    background-color: hsl(var(--primary) / 0.2);
    color: var(--foreground);
    font-weight: 600;
    border-radius: 0.125rem;
    padding: 0 0.125rem;
  }

  /* Safe area for mobile */
  .pb-safe {
    padding-bottom: env(safe-area-inset-bottom);
  }
</style>

<script>
  import { formatBlogDate } from "@/lib/utils";
  import {
    clearCallbacks,
    clearSearchIndex,
    getAllData,
    highlightText,
    initSearchIndex,
    search,
    setCallbacks,
  } from "@/lib/flexsearch";
  import type { SearchResult } from "@/pages/api/search-index.json";

  // DOM elements
  const modal = document.getElementById("search-modal");
  const searchInput = document.getElementById("search-input") as HTMLInputElement;
  const closeBtn = document.getElementById("close-search-modal");
  const skeleton = document.getElementById("search-skeleton");
  const emptyState = document.getElementById("search-empty");
  const errorState = document.getElementById("search-error");
  const resultsList = document.getElementById("search-results-list");
  const resultsContainer = document.getElementById("results-container");
  const footer = document.getElementById("search-footer");
  const retryBtn = document.getElementById("retry-search");
  const loadMoreBtn = document.getElementById("load-more-btn");
  const loadMoreContainer = document.getElementById("load-more-container");

  // State
  let isOpen = false;
  let results: SearchResult[] = [];
  let displayedCount = 10;
  let focusedIndex = -1;

  // Initialize search on page load
  let indexInitialized = false;

  // Set up callbacks
  setCallbacks(
    (searchResults) => {
      results = searchResults;
      displayedCount = 10;
      renderResults();
    },
    (loading) => {
      if (loading && !indexInitialized) {
        showSkeleton();
      }
    },
    (error) => {
      if (error) {
        showError(error);
      }
    }
  );

  function showSkeleton() {
    skeleton?.classList.remove("hidden");
    emptyState?.classList.add("hidden");
    errorState?.classList.add("hidden");
    resultsList?.classList.add("hidden");
    footer?.classList.add("hidden");
  }

  function showEmpty() {
    skeleton?.classList.add("hidden");
    emptyState?.classList.remove("hidden");
    emptyState?.classList.add("flex");
    errorState?.classList.add("hidden");
    resultsList?.classList.add("hidden");
    footer?.classList.remove("hidden");
    footer?.classList.add("flex");
  }

  function showError(_errorMsg: string) {
    skeleton?.classList.add("hidden");
    emptyState?.classList.add("hidden");
    errorState?.classList.remove("hidden");
    errorState?.classList.add("flex");
    resultsList?.classList.add("hidden");
    footer?.classList.add("hidden");
  }

  function showResults() {
    skeleton?.classList.add("hidden");
    emptyState?.classList.add("hidden");
    emptyState?.classList.remove("flex");
    errorState?.classList.add("hidden");
    errorState?.classList.remove("flex");
    resultsList?.classList.remove("hidden");
    footer?.classList.remove("hidden");
    footer?.classList.add("flex");
  }

  function renderResults() {
    if (!resultsContainer) return;

    const query = searchInput?.value || "";

    if (results.length === 0) {
      if (query.trim()) {
        showEmpty();
      } else {
        // Show initial state - maybe recent items
        const allData = getAllData();
        if (allData.length > 0) {
          results = allData.slice(0, 3);
          renderResultsList(results, query);
          showResults();
        } else {
          showEmpty();
        }
      }
      return;
    }

    const displayResults = results.slice(0, displayedCount);
    renderResultsList(displayResults, query);
    showResults();

    // Show/hide load more button
    if (loadMoreContainer) {
      if (results.length > displayedCount) {
        loadMoreContainer.classList.remove("hidden");
        if (loadMoreBtn) {
          loadMoreBtn.textContent = `Load more (${results.length - displayedCount} remaining)`;
        }
      } else {
        loadMoreContainer.classList.add("hidden");
      }
    }
  }

  function renderResultsList(items: SearchResult[], query: string) {
    if (!resultsContainer) return;

    resultsContainer.innerHTML = items
      .map((item, index) => {
        const icon = item.type === "blog" ? "file-text" : "code";
        const highlightedTitle = highlightText(item.title, query);
        const highlightedDesc = highlightText(item.description, query);

        return `
          <a
            href="${item.url}"
            class="search-result-item block p-4 focus:outline-none focus:bg-muted"
            data-index="${index}"
            data-focused="false"
          >
            <div class="flex items-start gap-3">
              <div class="shrink-0 mt-0.5">
                ${getIconSvg(icon)}
              </div>
              <div class="flex-1 min-w-0">
                <h4 class="font-medium text-foreground mb-1 line-clamp-1">
                  ${highlightedTitle}
                </h4>
                <p class="text-sm text-muted-foreground mb-2 line-clamp-2">
                  ${highlightedDesc}
                </p>
                <div class="flex items-center gap-3 text-xs text-muted-foreground">
                  <span class="flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    ${formatBlogDate(new Date(item.date))}
                  </span>
                  ${
                    item.tags.length > 0
                      ? `
                    <span class="flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                      </svg>
                      ${item.tags.slice(0, 3).join(", ")}
                      ${item.tags.length > 3 ? `+${item.tags.length - 3}` : ""}
                    </span>
                  `
                      : ""
                  }
                </div>
              </div>
            </div>
          </a>
        `;
      })
      .join("");

    // Update focused state
    updateFocusedResult();
  }

  function getIconSvg(type: string): string {
    if (type === "code") {
      return `<svg class="w-4 h-4 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
      </svg>`;
    }
    return `<svg class="w-4 h-4 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </svg>`;
  }

  function updateFocusedResult() {
    const resultItems = resultsContainer?.querySelectorAll("[data-index]");
    resultItems?.forEach((item, idx) => {
      item.setAttribute("data-focused", idx === focusedIndex ? "true" : "false");
    });
  }

  function openModal() {
    if (!modal || isOpen) return;

    isOpen = true;
    modal.classList.remove("hidden");
    modal.setAttribute("data-state", "open");
    modal.setAttribute("aria-hidden", "false");
    document.body.classList.add("search-modal-open");

    // Initialize search index if not already
    if (!indexInitialized) {
      initSearchIndex().then(() => {
        indexInitialized = true;
        renderResults();
      });
    }

    // Focus input
    setTimeout(() => {
      searchInput?.focus();
    }, 100);
  }

  function closeModal() {
    if (!modal || !isOpen) return;

    isOpen = false;
    modal.setAttribute("data-state", "closed");
    modal.setAttribute("aria-hidden", "true");
    document.body.classList.remove("search-modal-open");

    // Reset state
    focusedIndex = -1;
    if (searchInput) searchInput.value = "";

    // Hide after animation
    setTimeout(() => {
      modal.classList.add("hidden");
    }, 150);
  }

  function handleKeyDown(e: KeyboardEvent) {
    if (!isOpen) {
      // Cmd/Ctrl + K to open
      if ((e.metaKey || e.ctrlKey) && e.key === "k") {
        e.preventDefault();
        openModal();
      }
      return;
    }

    // Escape to close
    if (e.key === "Escape") {
      e.preventDefault();
      closeModal();
      return;
    }

    const resultItems = resultsContainer?.querySelectorAll("[data-index]");
    if (!resultItems || resultItems.length === 0) return;

    // Arrow navigation
    if (e.key === "ArrowDown") {
      e.preventDefault();
      focusedIndex = Math.min(focusedIndex + 1, resultItems.length - 1);
      updateFocusedResult();
      // Scroll into view
      const focused = resultItems[focusedIndex];
      focused?.scrollIntoView({ block: "nearest", behavior: "smooth" });
    } else if (e.key === "ArrowUp") {
      e.preventDefault();
      focusedIndex = Math.max(focusedIndex - 1, -1);
      updateFocusedResult();
      if (focusedIndex === -1) {
        searchInput?.focus();
      } else {
        const focused = resultItems[focusedIndex];
        focused?.scrollIntoView({ block: "nearest", behavior: "smooth" });
      }
    } else if (e.key === "Enter" && focusedIndex >= 0) {
      e.preventDefault();
      const focused = resultItems[focusedIndex] as HTMLElement;
      if (focused) {
        const href = focused.getAttribute("href");
        if (href) {
          window.location.href = href;
          closeModal();
        }
      }
    }
  }

  function handleSearchInput(e: Event) {
    const query = (e.target as HTMLInputElement).value;
    search(query);
  }

  function handleLoadMore() {
    displayedCount += 10;
    renderResults();
  }

  function handleRetry() {
    initSearchIndex().then(() => {
      indexInitialized = true;
      renderResults();
    });
  }

  // Event listeners
  closeBtn?.addEventListener("click", closeModal);
  searchInput?.addEventListener("input", handleSearchInput);
  retryBtn?.addEventListener("click", handleRetry);
  loadMoreBtn?.addEventListener("click", handleLoadMore);
  document.addEventListener("keydown", handleKeyDown);

  // Click outside to close
  modal?.addEventListener("click", (e) => {
    if (e.target === modal) {
      closeModal();
    }
  });

  // Expose open function globally for the header button
  (window as Window & { openSearchModal?: () => void }).openSearchModal = openModal;

  // Cleanup on page unload
  window.addEventListener("beforeunload", () => {
    clearCallbacks();
    clearSearchIndex();
  });

  // Astro view transitions support
  document.addEventListener("astro:after-swap", () => {
    clearCallbacks();
    clearSearchIndex();
    indexInitialized = false;
  });
</script>
