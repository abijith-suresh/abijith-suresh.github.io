---
import { X } from "lucide-astro";
---

<!-- Modal Overlay -->
<div
  id="search-modal"
  class="fixed inset-0 z-50 hidden bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0"
  aria-hidden="true"
  data-state="closed"
  style="view-transition-name: none;"
>
  <!-- Modal Container -->
  <div
    class="fixed left-1/2 top-0 sm:top-[10%] z-50 w-full max-w-full sm:max-w-lg md:max-w-2xl -translate-x-1/2 translate-y-0"
  >
    <div
      class="relative flex flex-col h-dvh sm:h-auto sm:max-h-[85vh] bg-background shadow-lg border border-border rounded-none sm:rounded-lg overflow-hidden data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:slide-out-to-top-0 data-[state=open]:slide-in-from-top-0 duration-200"
      role="dialog"
      aria-modal="true"
      aria-labelledby="search-title"
      data-state="closed"
      style="view-transition-name: none;"
    >
      <!-- Close Button (Desktop) - Absolute positioned -->
      <button
        id="close-search-modal-desktop"
        aria-label="Close search"
        class="hidden sm:block absolute right-4 top-4 p-1.5 text-muted-foreground hover:text-foreground hover:bg-muted rounded-md transition-colors z-10"
      >
        <X size={16} />
      </button>

      <!-- Search Content -->
      <div class="flex-1 min-h-0 overflow-hidden">
        <div id="search-container"></div>
      </div>
    </div>
  </div>
</div>

<style is:global>
  :root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: var(--primary);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-tag: var(--muted);
    --pagefind-ui-border-width: 0px;
    --pagefind-ui-border-radius: 0;
    --pagefind-ui-image-border-radius: 0.5rem;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-font: inherit;
  }

  /* Hide default Pagefind wrapper elements */
  .pagefind-ui {
    border: none !important;
    border-radius: 0 !important;
    background: transparent !important;
    padding: 0 !important;
  }

  /* Search input styling */
  .pagefind-ui__form {
    border-bottom: 1px solid var(--border) !important;
    padding: 0 !important;
    margin: 0 !important;
    background: transparent !important;
  }

  .pagefind-ui__search-input {
    background-color: transparent !important;
    border: none !important;
    color: var(--foreground) !important;
    font-size: 1rem !important;
    padding: 1rem 1rem 1rem 3rem !important;
    height: 3.5rem !important;
    outline: none !important;
    box-shadow: none !important;
  }

  .pagefind-ui__search-input:focus {
    outline: none !important;
    box-shadow: none !important;
    border: none !important;
  }

  .pagefind-ui__search-input::placeholder {
    color: var(--muted-foreground) !important;
  }

  /* Search icon */
  .pagefind-ui__search-clear {
    display: none !important;
  }

  /* Results container - Scrollable */
  .pagefind-ui__results {
    padding: 0 !important;
    margin: 0 !important;
    max-height: calc(85vh - 4rem) !important;
    overflow-y: auto !important;
    overscroll-behavior: contain !important;
    -webkit-overflow-scrolling: touch !important;
  }

  @media (max-width: 640px) {
    .pagefind-ui__results {
      max-height: calc(100dvh - 4rem) !important;
    }
  }

  /* Individual result item */
  .pagefind-ui__result {
    border: none !important;
    border-bottom: 1px solid var(--border) !important;
    background-color: transparent !important;
    padding: 1rem !important;
    margin: 0 !important;
    border-radius: 0 !important;
    cursor: pointer !important;
  }

  .pagefind-ui__result:hover,
  .pagefind-ui__result[data-focused="true"] {
    background-color: var(--muted) !important;
  }

  .pagefind-ui__result:last-child {
    border-bottom: none !important;
  }

  .pagefind-ui__result-link {
    text-decoration: none !important;
  }

  /* Result title */
  .pagefind-ui__result-title {
    color: var(--foreground) !important;
    font-size: 0.95rem !important;
    font-weight: 500 !important;
    margin-bottom: 0.25rem !important;
    display: flex !important;
    align-items: center !important;
    gap: 0.5rem !important;
  }

  /* Content type icon */
  .pagefind-ui__result-title::before {
    content: "" !important;
    display: inline-block !important;
    width: 1rem !important;
    height: 1rem !important;
    flex-shrink: 0 !important;
    background-size: contain !important;
    background-repeat: no-repeat !important;
    background-position: center !important;
    opacity: 0.7 !important;
  }

  /* Blog icon (FileText) */
  .pagefind-ui__result[data-content-type="blog"] .pagefind-ui__result-title::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z'/%3E%3Cpath d='M14 2v4a2 2 0 0 0 2 2h4'/%3E%3Cpath d='M10 9H8'/%3E%3Cpath d='M16 13H8'/%3E%3Cpath d='M16 17H8'/%3E%3C/svg%3E") !important;
  }

  /* Project icon (Code2) */
  .pagefind-ui__result[data-content-type="project"] .pagefind-ui__result-title::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m18 16 4-4-4-4'/%3E%3Cpath d='m6 8-4 4 4 4'/%3E%3Cpath d='m14.5 4-5 16'/%3E%3C/svg%3E") !important;
  }

  /* Tag icon (Tag) */
  .pagefind-ui__result[data-content-type="tag"] .pagefind-ui__result-title::before {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23888888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z'/%3E%3Ccircle cx='7.5' cy='7.5' r='.5' fill='%23888888'/%3E%3C/svg%3E") !important;
  }

  /* Dark mode icons - Use CSS filter to make them lighter */
  [data-theme="dark"] .pagefind-ui__result-title::before {
    filter: brightness(1.8) !important;
  }

  /* Result excerpt */
  .pagefind-ui__result-excerpt {
    color: var(--muted-foreground) !important;
    font-size: 0.875rem !important;
    line-height: 1.5 !important;
    margin: 0.25rem 0 !important;
  }

  /* Result tags */
  .pagefind-ui__result-tags {
    margin-top: 0.5rem !important;
  }

  .pagefind-ui__result-tag {
    background-color: var(--muted) !important;
    color: var(--muted-foreground) !important;
    border: none !important;
    font-size: 0.75rem !important;
    padding: 0.125rem 0.5rem !important;
    border-radius: 0.25rem !important;
  }

  /* Message styling (no results, loading, etc.) */
  .pagefind-ui__message {
    color: var(--muted-foreground) !important;
    padding: 2rem 1rem !important;
    text-align: center !important;
    font-size: 0.875rem !important;
  }

  /* Hide results count message (e.g., "4 results for typescript") */
  .pagefind-ui__results-area > .pagefind-ui__message {
    display: none !important;
  }

  /* Load more button */
  .pagefind-ui__button {
    background-color: var(--primary) !important;
    color: var(--primary-foreground) !important;
    border: none !important;
    padding: 0.5rem 1rem !important;
    border-radius: 0.375rem !important;
    font-size: 0.875rem !important;
    margin: 1rem auto !important;
    display: block !important;
  }

  .pagefind-ui__button:hover {
    opacity: 0.9 !important;
  }

  /* Hide result image/thumbnail */
  .pagefind-ui__result-image {
    display: none !important;
  }

  /* Search term highlighting - use theme primary color */
  .pagefind-ui__result-excerpt mark,
  .pagefind-ui__result-title mark {
    background-color: hsl(var(--primary) / 0.2) !important;
    color: var(--foreground) !important;
    font-weight: 600 !important;
    border-radius: 0.125rem !important;
    padding: 0 0.125rem !important;
  }

  /* Prevent body scroll when modal is open */
  body.search-modal-open {
    overflow: hidden;
  }

  /* Animation keyframes */
  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes fade-out {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  @keyframes slide-in-from-top {
    from {
      transform: translateY(-100%);
    }
    to {
      transform: translateY(0);
    }
  }

  @keyframes slide-out-to-top {
    from {
      transform: translateY(0);
    }
    to {
      transform: translateY(-100%);
    }
  }

  [data-state="open"] {
    animation: fade-in 180ms var(--ease-default);
  }

  [data-state="closed"] {
    animation: fade-out 180ms var(--ease-default);
  }
</style>

<script>
  import { cleanupSearchModal, initSearchModal } from "@/lib/search-modal";

  // Initialize on page load
  initSearchModal();

  // Cleanup and reinitialize on view transitions
  document.addEventListener("astro:before-swap", cleanupSearchModal);
  document.addEventListener("astro:after-swap", initSearchModal);
</script>
