---
import { Icon } from "astro-icon/components";
---

<button id="theme-toggle" aria-label="Toggle theme" class="icon-button p-2 cursor-pointer">
  <Icon name="fa6-solid:sun" class="w-4 h-4 hidden" id="theme-icon-light" />
  <Icon name="fa6-solid:moon" class="w-4 h-4 hidden" id="theme-icon-dark" />
</button>

<script>
  type Theme = "light" | "dark";

  function getSystemTheme(): Theme {
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }

  function getCurrentTheme(): Theme {
    const stored = localStorage.getItem("theme") as Theme | null;
    return stored || getSystemTheme();
  }

  function applyTheme(theme: Theme, withTransition = false) {
    const applyThemeChange = () => {
      document.documentElement.setAttribute("data-theme", theme);
      updateThemeIcon(theme);
    };

    // Use View Transition API if supported and requested
    if (withTransition && document.startViewTransition) {
      document.startViewTransition(() => applyThemeChange());
    } else {
      applyThemeChange();
    }
  }

  function updateThemeIcon(theme: Theme) {
    const lightIcon = document.getElementById("theme-icon-light");
    const darkIcon = document.getElementById("theme-icon-dark");

    if (theme === "light") {
      lightIcon?.classList.remove("hidden");
      darkIcon?.classList.add("hidden");
    } else {
      lightIcon?.classList.add("hidden");
      darkIcon?.classList.remove("hidden");
    }
  }

  function toggleTheme() {
    const currentTheme = getCurrentTheme();
    const newTheme: Theme = currentTheme === "light" ? "dark" : "light";

    // Save to localStorage (only set after first manual change)
    localStorage.setItem("theme", newTheme);

    // Apply with transition
    applyTheme(newTheme, true);
  }

  // Store event listener for cleanup
  let toggleHandler: (() => void) | null = null;
  let mediaQueryChangeHandler: (() => void) | null = null;
  let mediaQuery: MediaQueryList | null = null;

  function initThemeToggle() {
    const button = document.getElementById("theme-toggle");

    // Apply current theme without transition on init
    const currentTheme = getCurrentTheme();
    applyTheme(currentTheme, false);

    // Toggle theme on button click
    toggleHandler = () => toggleTheme();
    button?.addEventListener("click", toggleHandler);

    // Listen for system theme changes if user hasn't set a preference
    mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
    mediaQueryChangeHandler = () => {
      // Only respond to system changes if user hasn't explicitly set a preference
      if (!localStorage.getItem("theme")) {
        const systemTheme = getSystemTheme();
        applyTheme(systemTheme, false);
      }
    };
    mediaQuery.addEventListener("change", mediaQueryChangeHandler);
  }

  function cleanupThemeToggle() {
    const button = document.getElementById("theme-toggle");

    // Remove button click handler
    if (toggleHandler && button) {
      button.removeEventListener("click", toggleHandler);
      toggleHandler = null;
    }

    // Remove media query change handler
    if (mediaQueryChangeHandler && mediaQuery) {
      mediaQuery.removeEventListener("change", mediaQueryChangeHandler);
      mediaQueryChangeHandler = null;
      mediaQuery = null;
    }
  }

  // Initialize on page load
  initThemeToggle();

  // Cleanup and reinitialize on view transitions
  document.addEventListener("astro:before-swap", cleanupThemeToggle);
  document.addEventListener("astro:after-swap", initThemeToggle);
</script>
