---
/**
 * Mobile Table of Contents - Sticky header dropdown
 * Shows current section and expands to show all headings
 */
import type { MarkdownHeading } from "astro";
import { ChevronDown } from "lucide-astro";

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// Filter to h2 and h3 headings
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);

function getIndent(depth: number): string {
  return depth === 3 ? "ml-4" : "";
}
---

{
  filteredHeadings.length > 0 && (
    <div id="mobile-toc-container" class="w-full xl:hidden">
      <details class="group">
        <summary class="flex w-full cursor-pointer items-center justify-between">
          <div class="mx-auto flex w-full max-w-3xl items-center px-4 py-3">
            {/* Progress circle */}
            <div class="relative mr-2 size-4">
              <svg class="h-4 w-4" viewBox="0 0 24 24">
                <circle
                  class="text-primary/20"
                  cx="12"
                  cy="12"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <circle
                  id="mobile-toc-progress-circle"
                  class="text-primary"
                  cx="12"
                  cy="12"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-dasharray="62.83"
                  stroke-dashoffset="62.83"
                  transform="rotate(-90 12 12)"
                />
              </svg>
            </div>
            <span
              id="mobile-toc-current-section"
              class="text-muted-foreground grow truncate text-sm"
            >
              Overview
            </span>
            <span class="text-muted-foreground ml-2">
              <ChevronDown
                size={16}
                class="transition-transform duration-200 group-open:rotate-180"
              />
            </span>
          </div>
        </summary>

        <div class="mx-auto max-w-3xl max-h-[30vh] overflow-y-auto">
          <ul class="flex list-none flex-col gap-y-2 px-4 pb-4" id="mobile-table-of-contents">
            {filteredHeadings.map((heading) => (
              <li class:list={["px-4 text-sm text-foreground/60", getIndent(heading.depth)]}>
                <a
                  href={`#${heading.slug}`}
                  class="mobile-toc-item underline decoration-transparent underline-offset-[3px] transition-colors duration-200 hover:decoration-inherit"
                  data-heading-id={heading.slug}
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </details>
    </div>
  )
}

<script>
  const INITIAL_OVERVIEW_TEXT = "Overview";
  const HEADER_OFFSET = 100;
  const PROGRESS_CIRCLE_RADIUS = 10;
  const PROGRESS_CIRCLE_CIRCUMFERENCE = 2 * Math.PI * PROGRESS_CIRCLE_RADIUS;

  class MobileTOCState {
    progressCircle: HTMLElement | null = null;
    currentSectionText: HTMLElement | null = null;
    detailsElement: HTMLDetailsElement | null = null;
    listElement: HTMLElement | null = null;
    headings: HTMLElement[] = [];
    activeIds: string[] = [];

    reset() {
      this.progressCircle = document.getElementById("mobile-toc-progress-circle");
      this.currentSectionText = document.getElementById("mobile-toc-current-section");
      this.detailsElement = document.querySelector("#mobile-toc-container details");
      this.listElement = document.getElementById("mobile-table-of-contents");
      this.headings = [];
      this.activeIds = [];

      if (this.progressCircle) {
        this.progressCircle.style.strokeDasharray = PROGRESS_CIRCLE_CIRCUMFERENCE.toString();
        this.progressCircle.style.strokeDashoffset = PROGRESS_CIRCLE_CIRCUMFERENCE.toString();
      }
    }
  }

  const state = new MobileTOCState();

  class HeadingRegions {
    static build() {
      state.headings = Array.from(
        document.querySelectorAll<HTMLElement>(".prose h2[id], .prose h3[id]")
      );
    }

    static getVisibleIds(): string[] {
      if (state.headings.length === 0) return [];

      const viewportTop = window.scrollY + HEADER_OFFSET;
      const visibleIds: string[] = [];

      for (let i = state.headings.length - 1; i >= 0; i--) {
        const heading = state.headings[i];
        if (heading.offsetTop <= viewportTop) {
          visibleIds.push(heading.id);
          break;
        }
      }

      // If nothing found and we have headings, use the first one
      if (visibleIds.length === 0 && state.headings.length > 0) {
        visibleIds.push(state.headings[0].id);
      }

      return visibleIds;
    }
  }

  class MobileTOCLinks {
    static update(headingIds: string[]) {
      if (!state.listElement || !state.currentSectionText) return;

      state.listElement.querySelectorAll(".mobile-toc-item").forEach((item) => {
        const tocItem = item as HTMLElement;
        const headingId = tocItem.dataset.headingId;
        if (headingId && headingIds.includes(headingId)) {
          tocItem.classList.add("text-foreground");
        } else {
          tocItem.classList.remove("text-foreground");
        }
      });

      this.updateCurrentSectionText(headingIds);
    }

    static updateCurrentSectionText(headingIds: string[]) {
      if (!state.currentSectionText) return;

      let textToShow = INITIAL_OVERVIEW_TEXT;

      if (headingIds.length > 0) {
        const activeHeading = state.headings.find((h) => h.id === headingIds[0]);
        if (activeHeading && activeHeading.textContent) {
          textToShow = activeHeading.textContent.trim();
        }
      }

      state.currentSectionText.textContent = textToShow;
    }

    static setupInteraction() {
      if (!state.listElement) return;

      state.listElement.querySelectorAll(".mobile-toc-item").forEach((item) => {
        item.addEventListener("click", () => {
          if (state.detailsElement) state.detailsElement.open = false;
        });
      });
    }
  }

  class ProgressCircle {
    static update() {
      if (!state.progressCircle) return;

      const scrollableDistance = document.documentElement.scrollHeight - window.innerHeight;
      const scrollProgress =
        scrollableDistance > 0 ? Math.min(Math.max(window.scrollY / scrollableDistance, 0), 1) : 0;

      state.progressCircle.style.strokeDashoffset = (
        PROGRESS_CIRCLE_CIRCUMFERENCE *
        (1 - scrollProgress)
      ).toString();
    }
  }

  class MobileTOCController {
    static handleScroll() {
      const newActiveIds = HeadingRegions.getVisibleIds();

      if (JSON.stringify(newActiveIds) !== JSON.stringify(state.activeIds)) {
        state.activeIds = newActiveIds;
        MobileTOCLinks.update(state.activeIds);
      }

      ProgressCircle.update();
    }

    static handleResize() {
      HeadingRegions.build();
      const newActiveIds = HeadingRegions.getVisibleIds();
      if (JSON.stringify(newActiveIds) !== JSON.stringify(state.activeIds)) {
        state.activeIds = newActiveIds;
        MobileTOCLinks.update(state.activeIds);
      }
      ProgressCircle.update();
    }

    static init() {
      state.reset();
      HeadingRegions.build();

      if (!state.currentSectionText) return;

      if (state.headings.length === 0) {
        state.currentSectionText.textContent = INITIAL_OVERVIEW_TEXT;
        window.addEventListener("scroll", ProgressCircle.update, { passive: true });
        ProgressCircle.update();
        return;
      }

      state.activeIds = HeadingRegions.getVisibleIds();
      MobileTOCLinks.update(state.activeIds);
      ProgressCircle.update();

      MobileTOCLinks.setupInteraction();
      window.addEventListener("scroll", this.handleScroll, { passive: true });
      window.addEventListener("resize", this.handleResize, { passive: true });
    }

    static cleanup() {
      window.removeEventListener("scroll", this.handleScroll);
      window.removeEventListener("scroll", ProgressCircle.update);
      window.removeEventListener("resize", this.handleResize);
      state.activeIds = [];
      state.headings = [];
    }
  }

  document.addEventListener("astro:page-load", () => MobileTOCController.init());
  document.addEventListener("astro:after-swap", () => {
    MobileTOCController.cleanup();
    MobileTOCController.init();
  });
  document.addEventListener("astro:before-swap", () => MobileTOCController.cleanup());
</script>
