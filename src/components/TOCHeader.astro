---
import type { MarkdownHeading } from "astro";
import { ChevronDown } from "lucide-astro";
import { filterTocHeadings } from "@/lib/toc";
import { cn } from "@/lib/utils";

interface Props {
  headings: MarkdownHeading[];
  class?: string;
}

const { headings, class: className } = Astro.props;
const filteredHeadings = filterTocHeadings(headings);

function getIndent(depth: number): string {
  return depth === 3 ? "ml-4" : "";
}
---

{
  filteredHeadings.length > 0 && (
    <div id="mobile-toc-container" class:list={cn("w-full lg:hidden", className)}>
      <details class="group">
        <summary class="flex w-full cursor-pointer items-center justify-between">
          <div class="mx-auto flex w-full max-w-3xl items-center px-4 py-3">
            {/* Progress circle */}
            <div class="relative mr-2 size-4">
              <svg class="h-4 w-4" viewBox="0 0 24 24">
                <circle
                  class="text-primary/20"
                  cx="12"
                  cy="12"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                />
                <circle
                  id="mobile-toc-progress-circle"
                  class="text-primary"
                  cx="12"
                  cy="12"
                  r="10"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-dasharray="62.83"
                  stroke-dashoffset="62.83"
                  transform="rotate(-90 12 12)"
                />
              </svg>
            </div>
            <span
              id="mobile-toc-current-section"
              class="text-muted-foreground grow truncate text-sm"
            >
              Overview
            </span>
            <span class="text-muted-foreground ml-2">
              <ChevronDown
                size={16}
                class="transition-transform duration-200 group-open:rotate-180"
              />
            </span>
          </div>
        </summary>

        <div class="mx-auto max-w-3xl max-h-[30vh] overflow-y-auto">
          <ul class="flex list-none flex-col gap-y-2 px-4 pb-4" id="mobile-table-of-contents">
            {filteredHeadings.map((heading) => (
              <li class:list={["px-4 text-sm text-foreground/60", getIndent(heading.depth)]}>
                <a
                  href={`#${heading.slug}`}
                  class="mobile-toc-item underline decoration-transparent underline-offset-[3px] transition-all duration-200 hover:decoration-inherit"
                  data-heading-id={heading.slug}
                >
                  {heading.text}
                </a>
              </li>
            ))}
          </ul>
        </div>
      </details>
    </div>
  )
}

<script>
  import { createMobileTocController } from "@/lib/toc";

  const controller = createMobileTocController({
    overviewText: "Overview",
    headingSelector: ".prose h2[id], .prose h3[id]",
    headerOffset: 100,
    progressCircleId: "mobile-toc-progress-circle",
    currentSectionId: "mobile-toc-current-section",
    listId: "mobile-table-of-contents",
    containerSelector: "#mobile-toc-container details",
    enableSmoothScroll: true,
  });

  document.addEventListener("astro:page-load", () => controller.init());
  document.addEventListener("astro:after-swap", () => {
    controller.cleanup();
    controller.init();
  });
  document.addEventListener("astro:before-swap", () => controller.cleanup());
</script>
